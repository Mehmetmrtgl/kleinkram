<template>
    <FileHeader
        v-if="file"
        :file="file"
        @download="handleDownload"
        @copy-link="copyPublicLink"
        @copy-hash="copyHash"
        @copy-uuid="copyUuid"
    />

    <div v-if="file" class="q-my-lg">
        <!-- YAML/Text Preview -->
        <div v-if="isYaml" class="q-mb-lg">
            <h2 class="text-h4 q-mb-md">Content Preview</h2>
            <div
                v-if="yamlContent"
                class="bg-grey-1 q-pa-md rounded-borders border-solid"
            >
                <pre class="q-ma-none text-code" style="overflow-x: auto">{{
                    yamlContent
                }}</pre>
            </div>
            <div v-else class="row items-center q-gutter-sm text-grey-7">
                <q-spinner-dots size="1.5em" /> <span>Loading content...</span>
            </div>
        </div>

        <!-- Binary/ROS Preview -->
        <div v-else-if="displayTopics && preview.isReaderReady.value">
            <FileTopicTable
                :topics="file.topics"
                :is-loading="isLoading"
                :previews="preview.topicPreviews"
                :loading-state="preview.topicLoadingState"
                :topic-errors="preview.topicErrors"
                @load-preview="preview.fetchTopicMessages"
            />
        </div>

        <!-- Fallback / Unsupported -->
        <div
            v-else-if="!displayTopics && !isLoading"
            class="text-center q-pa-xl bg-grey-1 rounded-borders border-dashed text-grey-7"
        >
            <q-icon name="sym_o_description" size="4em" class="q-mb-md" />
            <div class="text-h6">No Preview Available</div>
            <div class="text-caption q-mt-xs">
                Preview not supported for
                <span class="text-weight-bold">.{{ fileExtension }}</span>
            </div>
        </div>

        <FileHistory :events="events" />

        <div
            v-if="preview.readerError.value"
            class="q-my-md text-negative text-center"
        >
            <q-icon name="sym_o_warning" /> {{ preview.readerError.value }}
        </div>
    </div>

    <div v-else class="text-center q-pa-md">
        <q-spinner size="3em" color="primary" />
        <div class="text-grey q-mt-sm">Loading file...</div>
    </div>
</template>

<script setup lang="ts">
import { FileState, FileType } from '@common/enum';
import { copyToClipboard, Notify } from 'quasar';
import {
    registerNoPermissionErrorHandler,
    useFile,
    useFileEvents,
} from 'src/hooks/query-hooks';
import { useFileUUID } from 'src/hooks/router-hooks';
import { _downloadFile } from 'src/services/generic';
import { downloadFile } from 'src/services/queries/file';
import { computed, ref, watch } from 'vue';
import FileHeader from './file-header.vue';
import FileHistory from './file-history.vue';

import { useRosmsgPreview } from '../../composables/use-rosmsg-preview';
import FileTopicTable from './file-topic-table.vue';

const fileUuid = useFileUUID();
const { isLoading, data: file, error, isLoadingError } = useFile(fileUuid);
registerNoPermissionErrorHandler(isLoadingError, fileUuid, 'file', error);
const { data: events } = useFileEvents(fileUuid);

const preview = useRosmsgPreview();
const yamlContent = ref<string | undefined>(undefined);

const fileExtension = computed(
    () => file.value?.filename?.split('.').pop()?.toLowerCase() ?? '',
);
const isYaml = computed(() => ['yml', 'yaml'].includes(fileExtension.value));
const isSupportedBinary = computed(() => {
    if (!file.value) return false;
    return (
        file.value.type === FileType.BAG || file.value.type === FileType.MCAP
    );
});
const displayTopics = computed(
    () => file.value?.state === FileState.OK && isSupportedBinary.value,
);

// --- Init ---
watch(
    () => file.value,
    async (currentFile) => {
        if (
            !currentFile ||
            currentFile.state !== FileState.OK ||
            preview.isReaderReady.value
        )
            return;

        try {
            const url = await downloadFile(currentFile.uuid, false, true);

            if (isYaml.value) {
                const results = await fetch(url);
                yamlContent.value = results.ok
                    ? await results.text()
                    : 'Error loading content';
            } else if (isSupportedBinary.value) {
                const type =
                    currentFile.type === FileType.BAG ? 'rosbag' : 'mcap';
                await preview.init(url, type);
            }
        } catch (error_) {
            console.error(error_);
        }
    },
    { immediate: true },
);

// --- Actions ---
const handleDownload = (): Promise<void> =>
    _downloadFile(file.value?.uuid ?? '', file.value?.filename ?? '');
const copyHash = (): Promise<void> => copyToClipboard(file.value?.hash ?? '');
const copyUuid = (): Promise<void> => copyToClipboard(file.value?.uuid ?? '');
async function copyPublicLink(): Promise<void> {
    if (!fileUuid.value) return;
    const link = await downloadFile(fileUuid.value, false);
    await copyToClipboard(link);
    Notify.create({
        message: 'Copied: Link valid for 7 days',
        color: 'positive',
    });
}
</script>

<style scoped>
.text-code {
    font-family: monospace;
    font-size: 13px;
}
.border-solid {
    border: 1px solid #e0e0e0;
}
.border-dashed {
    border: 2px dashed #e0e0e0;
}
</style>
