import {
    Column,
    Entity,
    JoinTable,
    ManyToMany,
    ManyToOne,
    OneToMany,
    Unique,
} from 'typeorm';
import { FileOrigin, FileState, FileType } from '../../frontend_shared/enum';
import BaseEntity from '../base-entity.entity';
import CategoryEntity from '../category/category.entity';
import MissionEntity from '../mission/mission.entity';
import TopicEntity from '../topic/topic.entity';
import UserEntity from '../user/user.entity';

@Entity({ name: 'file_entity' })
@Unique('unique_file_name_per_mission', ['filename', 'mission'])
export default class FileEntity extends BaseEntity {
    @ManyToOne(() => MissionEntity, (mission) => mission.files, {
        nullable: false,
    })
    mission?: MissionEntity;

    @Column()
    date!: Date;

    @OneToMany(() => TopicEntity, (topic) => topic.file)
    topics?: TopicEntity[];

    @Column()
    filename!: string;

    @Column({
        type: 'bigint',
        transformer: {
            to: (value: number) => value,
            from: (value: string) => Number.parseInt(value, 10),
        },
    })
    size?: number;

    /**
     * The user who uploaded the file.
     */
    @ManyToOne(() => UserEntity, (user) => user.files, { nullable: false })
    creator?: UserEntity;

    @Column()
    type!: FileType;

    @Column({ default: FileState.OK })
    state!: FileState;

    @Column({ nullable: true })
    hash?: string;

    @ManyToMany(() => CategoryEntity, (category) => category.files)
    @JoinTable()
    categories?: CategoryEntity[];

    /**
     * The parent file this file was derived from.
     * e.g., If this is a .mcap converted from a .bag, the .bag is the parent.
     */
    @ManyToOne(() => FileEntity, (file) => file.derivedFiles, {
        nullable: true,
        onDelete: 'SET NULL',
    })
    parent?: FileEntity;

    /**
     * Files derived from this file.
     */
    @OneToMany(() => FileEntity, (file) => file.parent)
    derivedFiles?: FileEntity[];

    @Column({ nullable: true })
    origin?: FileOrigin;
}
